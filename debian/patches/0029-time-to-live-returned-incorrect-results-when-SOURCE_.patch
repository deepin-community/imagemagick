From: Cristy <urban-warrior@imagemagick.org>
Date: Wed, 11 Oct 2023 17:41:42 -0400
Subject: time-to-live returned incorrect results when SOURCE_DATE_EPOCH set

FTBFS during debian build

bug: https://github.com/ImageMagick/ImageMagick6/issues/278
origin: https://github.com/ImageMagick/ImageMagick6/commit/eb9ac36ffbeb57bebeefe48a8c9b0bb1f057561b.patch
---
 magick/cache.c | 2 +-
 magick/timer.c | 5 +++--
 2 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/magick/cache.c b/magick/cache.c
index dc6de89..8180f91 100644
--- a/magick/cache.c
+++ b/magick/cache.c
@@ -1859,7 +1859,7 @@ static Cache GetImagePixelCache(Image *image,const MagickBooleanType clone,
     cpu_throttle=GetMagickResourceLimit(ThrottleResource);
   if ((cycles++ % 4096) == 0)
     {
-      if (GetMagickTTL() < 0)
+      if (GetMagickTTL() <= 0)
         {
           cache_info=(CacheInfo *) image->cache;
           if (cache_info->file != -1)
diff --git a/magick/timer.c b/magick/timer.c
index 5041092..8c6c9e1 100644
--- a/magick/timer.c
+++ b/magick/timer.c
@@ -346,7 +346,8 @@ MagickExport time_t GetMagickTime(void)
           time_t
             epoch;
 
-          epoch=(time_t) StringToDouble(source_date_epoch,(char **) NULL);
+          epoch=(time_t) CastDoubleToLong(StringToDouble(source_date_epoch,
+            (char **) NULL));
           if ((epoch > 0) && (epoch <= time((time_t *) NULL)))
             constant_magick_time=epoch;
         }
@@ -388,7 +389,7 @@ MagickPrivate MagickOffsetType GetMagickTTL(void)
       magick_epoch=time((time_t *) NULL);
     }
   return((MagickOffsetType) GetMagickResourceLimit(TimeResource)-
-    (GetMagickTime()-magick_epoch));
+    (time((time_t *) NULL)-magick_epoch));
 }
 
 /*
